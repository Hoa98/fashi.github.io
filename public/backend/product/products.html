<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Admin</title>
  <link rel="stylesheet" href="../css/bootstrap.min.css">
  <link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css"
    integrity="sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p" crossorigin="anonymous" />
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700" rel="stylesheet">
  <link rel="stylesheet" href="../css/style.css">
</head>

<body>
  <div id="wrapper">
    <!-- NAVBAR -->
    <nav class="navbar nav-top">
      <div class="brand ml-5 mr-4">
        <h2><a href="../index.html"><img src="../../frontend/img/footer-logo.png" alt=""></a></h2>
      </div>
      <div class="container-fluid">
        <div class="navbar-btn ml-5 mr-5">
          <button type="button" class="btn-toggle-fullwidth  btn-default"><i class="fas fa-bars"></i></button>
        </div>
        <div id="navbar-menu" class="mr-5">
          <div class="dropdown no-arrow">
            <a class="btn-transparent dropdown-toggle" href="#" role="button" id="dropdownMenuLink"
              data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              <img src="http://lorempixel.com/30/30/" width="30" height="30" class="rounded-circle" alt="Avatar">
              <span class="text-white ml-3"> Admin <i class="icon-submenu fal fa-chevron-down"></i></span>
            </a>

            <div class="dropdown-menu" aria-labelledby="dropdownMenuLink">
              <li><a href="#"><i class="fal fa-envelope"></i> <span>Thông tin</span></a></li>
              <li><a href="#"><i class="fal fa-cog"></i> <span>Cài đặt</span></a></li>
              <li><button class="btn border-0 js-logout"><i class="fal fa-sign-out"></i> <span>Đăng xuất</span></button>
              </li>
            </div>
          </div>
        </div>

      </div>
    </nav>
    <!-- END NAVBAR -->
    <!-- LEFT SIDEBAR -->
    <div id="sidebar-nav" class="sidebar">
      <div class="sidebar-scroll">
        <nav>
          <ul class="nav">
            <li><a href="../index.html"><i class="fal fa-home"></i> <span>Trang chủ</span></a></li>
            <li><a href="../category/categories.html"><i class="fal fa-book-alt"></i> <span>Danh mục</span></a></li>
            <li><a href="products.html" class="active"><i class="fal fa-chart-bar"></i> <span>Sản phẩm</span></a></li>
            <li><a href="../user/users.html"><i class="fal fa-user-alt"></i> <span>Tài khoản</span></a></li>
            <li>
              <a href="#subPages" data-toggle="collapse" class="collapsed"><i class="fal fa-file-alt"></i>
                <span>Bài viết</span> <i class="icon-submenu fal fa-chevron-left"></i></a>
              <div id="subPages" class="collapse ">
                <ul class="nav">
                  <li><a href="../post/posts.html">Tất cả bài viết</a></li>
                  <li><a href="../post/add-post.html">Thêm bài viết</a></li>
                </ul>
              </div>
            </li>
            <li><a href="../contact/contact.html"><i class="fal fa-address-book"></i> <span>Liên hệ</span></a></li>
            <li><a href="../order/orders.html"><i class="fal fa-cart-plus"></i> <span>Hóa đơn</span></a></li>
            <li><a href="../slider/sliders.html"><i class="fal fa-file-image"></i> <span>Slider</span></a></li>
          </ul>
        </nav>
      </div>
    </div>
    <!-- END LEFT SIDEBAR -->
    <!-- MAIN -->
    <div class="main">
      <!-- MAIN CONTENT -->
      <div class="main-content">
        <div class="mb-3 row">
          <div class="col-6">
            <h3>Danh sách sản phẩm</h3>
          </div>
          <div class="col-4 offset-2">
            <form class="form-inline search-form mr-auto d-none d-sm-block" action="">
              <div class="input-group">
                <input type="text" id="keyword" name="keyword" class="form-control" placeholder="Tên sản phẩm..."
                  required>
              </div>
            </form>
          </div>
        </div>
        <table class="table table-bordered  table-hover mt-4">
          <thead>
            <th>Id</th>
            <th style="width: 200px;">Tên sản phẩm</th>
            <th>Danh mục</th>
            <th>Ảnh</th>
            <th>Giá</th>
            <th>Số lượng</th>
            <th>Gallery</th>
            <th>Bình luận</th>
            <th>Đánh giá</th>
            <th>
              <a href="add-pro.html" class="btn btn-primary btn-sm">Thêm sản phẩm</a>
            </th>
          </thead>
          <tbody id="list-pro">
            <tr>

            </tr>
          </tbody>
        </table>

        <!-- Modal -->
        <div class="modal fade" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel"> </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                <div class="row">
                </div>
              </div>
              <div class="modal-footer">

              </div>
            </div>
          </div>
        </div>
        <!-- Phan trang -->
<nav>
  <ul class="pagination js-page justify-content-center">

  </ul>
</nav>
      </div>
      <!-- END MAIN CONTENT -->
    </div>
    <!-- END MAIN -->
    <footer>
      <div class="container-fluid">
        <p class="copyright text-right pt-2">&copy; 2020 All Rights Reserved.</p>
      </div>
    </footer>
  </div>
  <script src="../js/jquery-3.5.1.min.js"></script>
  <script src="../js/popper.min.js"></script>
  <script src="../js/bootstrap.min.js"></script>
  <script src="../js/sweetalert2/dist/sweetalert2.all.min.js"></script>
  <script src="../js/common.js"></script>
  <script>
    window.onload = function () {
      const $ = document.querySelector.bind(document);
      function getpro(url, limit, currentPage) {
        fetch(url + "&_page=" + currentPage + '&_limit=' + limit, {
          method: "GET"
        }).then(response => response.json())
          .then(data => {
            fetch("http://localhost:3000/product", {
                        method: "GET"
                    }).then(response => response.json())
                        .then(data => {
                            let numberPage = Math.ceil(data.length / limit);
                            let pagination = '';
                            if (currentPage > 1) {
                                pagination = `<li class="page-item"><button onclick="showPage(this)" class="page-link" value="-1">&#10094;</button></li>`;
                            } else {
                                pagination = '';
                            }
                            for (var i = 0; i < numberPage; i++) {
                                pagination += `<li class="page-item"><button onclick="showPage(this)" class="page-link ${currentPage == i + 1 ? 'active' : ''}" value="${i + 1}">${i + 1}</button></li>`;
                            }
                            if (numberPage > currentPage) {
                                pagination += `<li class="page-item"><button onclick="showPage(this)" class="page-link" value="-2">&#10095;</button></li>`;
                            }
                            document.querySelector('ul.pagination.js-page').innerHTML = pagination;
                        });
            let result = data.map((pro, index) => {
              return `
                <tr>
                <td>${pro.id}</td>
                <td>${pro.name}</td>
                <td id="cate_name${pro.id}">${getCateName(pro.cate_id, pro.id)}</td>
                <td><img src='${pro.images}' width = "70"></td>
                <td><span class="text-warning font-weight-bold">${new Intl.NumberFormat('de-DE').format(pro.price - (pro.price * pro.sale))}đ</span> ${pro.sale > 0 ? "<del>" + new Intl.NumberFormat('de-DE').format(pro.price) + "</del>đ" : ""}</td>
                <td>${pro.so_luong}</td>
                <td id="number_gal${pro.id}"> ${getNumberGallery(pro.id, pro.name)}</td>
                <td id="number_com${pro.id}"> ${getNumberCom(pro.id)}</td>
                <td>${pro.rating}</td>
                <td>
                  <a href="http://localhost:3000/frontend/product.html?id=${pro.id}" target="_blank" class="btn btn-sm btn-secondary"><i class="fa fa-eye"></i></a>
                <a href="edit-pro.html?id=${pro.id}" class="btn btn-sm btn-info">Edit</a>
                        <button type="button" class="btn btn-sm btn-danger btn-remove" onclick="DeleteRow(${pro.id})">Remove</button></td>
                </tr>
                `
            }).join("");
            $('#list-pro').innerHTML = result;

          })
      }
      getpro("http://localhost:3000/product?_sort=id&_order=desc",10,1);

      let search_pro = document.querySelector('#keyword');
      search_pro.addEventListener('input', function () {
        load_pro(`http://localhost:3000/product?name_like=${search_pro.value}`,20,1)
      })
     
    }
    function showPage(e) {
            let currentPage = Number(document.querySelector('ul.pagination.js-page li.page-item .page-link.active').value);
            let page = Number(e.value);
            let limit = 10;
            if (page == -1) {
                page = currentPage - 1;
                load_pro("http://localhost:3000/product?_sort=id&_order=desc", limit, page);
            } if (page == -2) {
                page = currentPage + 1;
                load_pro("http://localhost:3000/product?_sort=id&_order=desc", limit, page);
            }
            load_pro("http://localhost:3000/product?_sort=id&_order=desc", limit, page);
        }
function getNumberCom(id){
  fetch("http://localhost:3000/comment_pro?pro_id=" + id, {
        method: "GET"
      }).then(response => response.json())
        .then(data => {
          document.querySelector('#number_com' + id).innerHTML = `<a href="comPro.html?id=${id}" class="btn btn-sm btn-success">${data.length} bình luận</a>`;
        })
}
    function getCateName(id, pro_id) {
      fetch("http://localhost:3000/categories/" + id, {
        method: "GET"
      }).then(response => response.json())
        .then(data => {
          document.querySelector('#cate_name' + pro_id).innerHTML = data.name;
        })
    }
    function getNumberGallery(id, name) {
      fetch("http://localhost:3000/gallery", {
        method: "GET"
      }).then(response => response.json())
        .then(data => {
          var total = 0;
          data.forEach(function (gallery, index, arr) {
            if (gallery.product_id == id) {
              total++;
            }
          })
          document.querySelector('#number_gal' + id).innerHTML = ` <button class="btn btn-sm btn-info" data-toggle="modal" data-target="#gallery-${id}" onclick="show_gall(${id},'${name}')">
                                                                      ${total} ảnh
                                                                    </button>`;

        })
    }

    function DeleteRow(id) {
      Swal.fire({
        title: 'Cảnh báo!',
        text: "Bạn chắc chắn muốn xóa sản phẩm này?",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Đồng ý!'
      }).then((result) => {
        if (result.value) {
          var url = 'http://localhost:3000/product/' + id;
          fetch(url, {
            method: "DELETE"
          }).then(function (res) {
            return res.json(); // chuyển chuỗi nhận được thành đối tượng json
          }).then(function (data) {
            // các lệnh xử lý cho dữ liệu ở đây: các công việc hiển thị.
            fetch("http://localhost:3000/gallery?product_id=" + id, {
              method: "GET"
            }).then(response => response.json())
              .then(data => {
                data.forEach(function (gall, index, arr) {
                  remove_gall(gall.id);
                })
              });
            Swal.fire({
              icon: 'success',
              title: 'Đã xóa',
              showConfirmButton: false,
              timer: 1500
            })
            load_pro("http://localhost:3000/product?_sort=id&_order=desc",10,1);
          });
        }
      })
      return false;
    }
    function remove_gall(id) {
      var url = 'http://localhost:3000/gallery/' + id;
      fetch(url, {
        method: "DELETE"
      }).then(function (res) {
        return res.json(); // chuyển chuỗi nhận được thành đối tượng json
      }).then(function (data) {
        console.log(data);
      });
    }
    function load_pro(url, limit, currentPage) {
      const $ = document.querySelector.bind(document);
      fetch(url + "&_page=" + currentPage + '&_limit=' + limit, {
        method: "GET"
      }).then(response => response.json())
        .then(data => {
          fetch("http://localhost:3000/product", {
                        method: "GET"
                    }).then(response => response.json())
                        .then(data => {
                            let numberPage = Math.ceil(data.length / limit);
                            let pagination = '';
                            if (currentPage > 1) {
                                pagination = `<li class="page-item"><button onclick="showPage(this)" class="page-link" value="-1">&#10094;</button></li>`;
                            } else {
                                pagination = '';
                            }
                            for (var i = 0; i < numberPage; i++) {
                                pagination += `<li class="page-item"><button onclick="showPage(this)" class="page-link ${currentPage == i + 1 ? 'active' : ''}" value="${i + 1}">${i + 1}</button></li>`;
                            }
                            if (numberPage > currentPage) {
                                pagination += `<li class="page-item"><button onclick="showPage(this)" class="page-link" value="-2">&#10095;</button></li>`;
                            }
                            document.querySelector('ul.pagination.js-page').innerHTML = pagination;
                        });
          const result = data.map((pro, index) => {
            return `
            <tr>
                <td>${pro.id}</td>
                <td>${pro.name}</td>
                <td id="cate_name${pro.id}">${getCateName(pro.cate_id, pro.id)}</td>
                <td><img src='${pro.images}' width = "70"></td>
                <td><span class="text-warning font-weight-bold">${new Intl.NumberFormat('de-DE').format(pro.price - (pro.price * pro.sale))}đ</span> ${pro.sale > 0 ? "<del>" + new Intl.NumberFormat('de-DE').format(pro.price) + "</del>đ" : ""}</td>
                <td>${pro.so_luong}</td>
                <td id="number_gal${pro.id}"> ${getNumberGallery(pro.id, pro.name)}</td>
                <td id="number_com${pro.id}"> ${getNumberCom(pro.id)}</td>
                <td>${pro.rating}</td>
                <td>
                  <a href="http://localhost:3000/frontend/product.html?id=${pro.id}" target="_blank" class="btn btn-sm btn-secondary"><i class="fa fa-eye"></i></a>
                <a href="edit-pro.html?id=${pro.id}" class="btn btn-sm btn-info">Edit</a>
                <button type="button" class="btn btn-sm btn-danger btn-remove" onclick="DeleteRow(${pro.id})">Remove</button></td>
                </tr>
            `
          }).join("");
          console.log();
          $('#list-pro').innerHTML = result;
        })
    }
    function show_gall(id_pro, name) {
      var row = document.createElement('div');
      row.classList = "row";
      document.querySelector('.modal-body').innerHTML = "";
      document.querySelector('.modal-body').appendChild(row);
      document.querySelector('.modal').setAttribute('id', 'gallery-' + id_pro);
      document.querySelector('.modal-title').innerHTML = `Gallery của sản phẩm ${name}`;
      document.querySelector('.modal-footer').innerHTML = `<button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-info" onclick="addGall(${id_pro})">Thêm ảnh</button>
                <button type="button" class="btn btn-success" onclick="show_gall(${id_pro},'${name}')">Chi tiết</button>`;
      var modal_body = document.querySelector('.modal-body .row');
      fetch("http://localhost:3000/gallery?product_id=" + id_pro, {
        method: "GET"
      }).then(response => response.json())
        .then(data => {
          var res_modal = data.map(function (gallery, index, arr) {
            return `<div class="col-4 position-relative mb-3 img-gallery">
                    <img src="${gallery.images}" class="img-thumbnail">
                    <button type="button" class="close position-absolute btn_remove" onclick="removeGall(${gallery.id},${gallery.product_id})">
                      <span aria-hidden="true">&times;</span>
                    </button>
                    <div class="momo">
                      <button type="button" class="btn-sm btn-success nutdong" onclick="editGall(${gallery.id},'${gallery.images}',${gallery.product_id})">Cập
                        nhật</button>
                    </div>

                  </div>`;
          }).join("");
          modal_body.innerHTML = res_modal;
        })
    }
    function addGall(id_pro) {
      var modal_body = document.querySelector('.modal-body');
      modal_body.innerHTML = ` <h3 class="text-center text-info">Tạo mới ảnh sản phẩm</h3>
    <form>
        <div class="form-group">
            <label for="">Ảnh sản phẩm</label>
            <input type="text" name="images" id="file" class="form-control">
        </div>
        <div class="text-center">
            <button type="button" class="btn btn-success pl-3 pr-3" onclick="saveAddGall(${id_pro})">Lưu</button>
        </div>
    </form>
`;
    }
    function editGall(id, images, id_pro) {
      var modal_body = document.querySelector('.modal-body');
      modal_body.innerHTML = ` <h3 class="text-center text-info">Cập nhật ảnh sản phẩm</h3>
    <form>
        <div class="form-group">
            <img src="${images}" id="my-img" alt="" class="img-fluid">
            <input type="text" name="img_url" id="file" class="form-control">
        </div>
        <div class="text-center">
            <button type="button" class="btn btn-success pl-5 pr-5" onclick="saveEditGall(${id},${id_pro})">Lưu</button>
        </div>
    </form>`;
    }
    function removeGall(id, id_pro) {
      fetch('http://localhost:3000/gallery/' + id, {
        method: "DELETE"
      }).then(function (res) {
        return res.json(); // chuyển chuỗi nhận được thành đối tượng json
      }).then(function (data) {
        fetch('http://localhost:3000/product?id=' + id_pro, {
          method: "GET"
        }).then(function (res) {
          return res.json();
        }).then(function (data) {
          data.forEach(function (pro, index, arr) {
            show_gall(id_pro, pro.name);
          })
        })
      })
    }
    function saveAddGall(id_pro) {

      var images = document.querySelector('#file').value;
      var dataPost = {
        images: images,
        product_id: id_pro
      };
      fetch('http://localhost:3000/gallery', {
        method: 'POST', // thêm mới thì dùng post
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(dataPost),
      }).then((response) => response.json()) // chuyển kết quả trả về thành json object
        .then((data) => {
          fetch('http://localhost:3000/product?id=' + id_pro, {
            method: "GET"
          }).then(function (res) {
            return res.json();
          }).then(function (data) {
            data.forEach(function (pro, index, arr) {
              show_gall(id_pro, pro.name);
            })
          })
        })
        .catch((error) => {

          console.error('Error:', error); // ghi log nếu xảy ra lỗi
        });
    }
    function saveEditGall(id, id_pro) {

      var images = document.querySelector('#file').value;
      var img = document.querySelector("#my-img").getAttribute("src");
      if (images === "") {
        images = img;
      }
      var dataPost = {
        images: images
      };
      fetch('http://localhost:3000/gallery/' + id, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(dataPost),
      }).then((response) => response.json()) // chuyển kết quả trả về thành json object
        .then((data) => {
          fetch('http://localhost:3000/product?id=' + id_pro, {
            method: "GET"
          }).then(function (res) {
            return res.json();
          }).then(function (data) {
            data.forEach(function (pro, index, arr) {
              show_gall(id_pro, pro.name);
            })
          })
        })
        .catch((error) => {

          console.error('Error:', error); // ghi log nếu xảy ra lỗi
        });
    }
  </script>
</body>

</html>